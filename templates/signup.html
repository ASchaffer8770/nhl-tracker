{% extends "base.html" %}
{% block title %}Sign Up{% endblock %}
{% block content %}
    <div class="login-card">
        <h2>Sign Up for Your Playoff Tracker</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form method="POST" id="signup-form" action="{{ url_for('signup') }}">
            <div class="form-content">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required aria-required="true" aria-describedby="username-status" pattern="[a-zA-Z0-9]+" minlength="3">
                    <span id="username-status" class="error-message" style="display: none;"></span>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required aria-required="true" aria-describedby="password-status" minlength="6">
                    <span id="password-status" class="error-message" style="display: none;"></span>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" required aria-required="true" aria-describedby="password-status" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Sign Up</button>
                <a href="{{ url_for('login') }}" class="btn btn-secondary">Login</a>
            </div>
        </form>
    </div>

    <script>
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const passwordStatus = document.getElementById('password-status');
        const submitBtn = document.getElementById('submit-btn');
        const usernameInput = document.getElementById('username');
        const usernameStatus = document.getElementById('username-status');

        let isUsernameAvailable = false;
        let isPasswordValid = false;

        function validateUsername() {
            const username = usernameInput.value.trim();
            const usernameRegex = /^[a-zA-Z0-9]+$/;
            if (username.length === 0) {
                usernameStatus.textContent = 'Username is required.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameAvailable = false;
                console.log('Username validation: Empty username');
                return false;
            } else if (username.length < 3) {
                usernameStatus.textContent = 'Username must be at least 3 characters.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameAvailable = false;
                console.log('Username validation: Too short');
                return false;
            } else if (!usernameRegex.test(username)) {
                usernameStatus.textContent = 'Username must be alphanumeric.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameAvailable = false;
                console.log('Username validation: Not alphanumeric');
                return false;
            }
            return true;
        }

        function validatePasswords() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            if (password.length === 0 || confirmPassword.length === 0) {
                passwordStatus.textContent = 'Please enter both passwords.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('success-message');
                passwordStatus.classList.add('error-message');
                isPasswordValid = false;
                console.log('Password validation: Empty fields');
            } else if (password.length < 6) {
                passwordStatus.textContent = 'Password must be at least 6 characters.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('success-message');
                passwordStatus.classList.add('error-message');
                isPasswordValid = false;
                console.log('Password validation: Too short');
            } else if (password !== confirmPassword) {
                passwordStatus.textContent = 'Passwords do not match.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('success-message');
                passwordStatus.classList.add('error-message');
                isPasswordValid = false;
                console.log('Password validation: Mismatch');
            } else {
                passwordStatus.textContent = 'Passwords match.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('error-message');
                passwordStatus.classList.add('success-message');
                isPasswordValid = true;
                console.log('Password validation: Valid');
            }
            checkFormValidity();
        }

        function checkFormValidity() {
            submitBtn.disabled = !(isUsernameAvailable && isPasswordValid);
            console.log(`Form validity: username=${isUsernameAvailable}, password=${isPasswordValid}, button disabled=${submitBtn.disabled}`);
        }

        function checkUsername() {
            const username = usernameInput.value.trim();
            if (!validateUsername()) {
                isUsernameAvailable = false;
                checkFormValidity();
                return;
            }

            fetch('/check_username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&mode=signup`
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log('Username check response:', data);
                usernameStatus.textContent = data.message;
                usernameStatus.style.display = 'block';
                if (data.available) {
                    usernameStatus.classList.remove('error-message');
                    usernameStatus.classList.add('success-message');
                    isUsernameAvailable = true;
                } else {
                    usernameStatus.classList.remove('success-message');
                    usernameStatus.classList.add('error-message');
                    isUsernameAvailable = false;
                }
                checkFormValidity();
            })
            .catch(error => {
                console.error('Error checking username:', error);
                usernameStatus.textContent = 'Error checking username.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameAvailable = false;
                checkFormValidity();
            });
        }

        // Event listeners
        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
        usernameInput.addEventListener('input', () => {
            clearTimeout(usernameInput.debounce);
            usernameInput.debounce = setTimeout(checkUsername, 500);
        });

        // Form submission handler
        document.getElementById('signup-form').addEventListener('submit', (event) => {
            if (submitBtn.disabled) {
                event.preventDefault();
                console.log('Form submission prevented: Button is disabled');
            } else {
                console.log('Form submission allowed: Valid inputs');
            }
        });

        // Initial validation
        validateUsername();
        validatePasswords();
    </script>
{% endblock %}