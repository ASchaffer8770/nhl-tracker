{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block content %}
    <div class="login-card">
        <h2>Login to Your Playoff Tracker</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form method="POST" id="login-form" action="{{ url_for('login') }}">
            <div class="form-content">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required aria-required="true" aria-describedby="username-status" pattern="[a-zA-Z0-9]+" minlength="3" autocomplete="username" autocapitalize="none">
                    <span id="username-status" class="error-message" style="display: none;"></span>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required aria-required="true" aria-describedby="password-status" minlength="6" autocomplete="current-password">
                    <span id="password-status" class="error-message" style="display: none;"></span>
                </div>
                <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Login</button>
                <a href="{{ url_for('signup') }}" class="btn btn-secondary">Sign Up</a>
            </div>
        </form>
    </div>

    <script>
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const usernameStatus = document.getElementById('username-status');
        const passwordStatus = document.getElementById('password-status');
        const submitBtn = document.getElementById('submit-btn');

        let isUsernameValid = false;
        let isPasswordValid = false;

        function validateUsername() {
            const username = usernameInput.value.trim();
            const usernameRegex = /^[a-zA-Z0-9]+$/;
            if (username.length === 0) {
                usernameStatus.textContent = 'Username is required.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameValid = false;
                console.log('Username validation: Empty username');
                return false;
            } else if (username.length < 3) {
                usernameStatus.textContent = 'Username must be at least 3 characters.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameValid = false;
                console.log('Username validation: Too short');
                return false;
            } else if (!usernameRegex.test(username)) {
                usernameStatus.textContent = 'Username must be alphanumeric.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameValid = false;
                console.log('Username validation: Not alphanumeric');
                return false;
            }
            return true;
        }

        function validatePassword() {
            const password = passwordInput.value;
            if (password.length === 0) {
                passwordStatus.textContent = 'Password is required.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('success-message');
                passwordStatus.classList.add('error-message');
                isPasswordValid = false;
                console.log('Password validation: Empty password');
            } else if (password.length < 6) {
                passwordStatus.textContent = 'Password must be at least 6 characters.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('success-message');
                passwordStatus.classList.add('error-message');
                isPasswordValid = false;
                console.log('Password validation: Too short');
            } else {
                passwordStatus.textContent = 'Password is valid.';
                passwordStatus.style.display = 'block';
                passwordStatus.classList.remove('error-message');
                passwordStatus.classList.add('success-message');
                isPasswordValid = true;
                console.log('Password validation: Valid');
            }
            checkFormValidity();
        }

        function checkFormValidity() {
            submitBtn.disabled = !(isUsernameValid && isPasswordValid);
            console.log(`Form validity: username=${isUsernameValid}, password=${isPasswordValid}, button disabled=${submitBtn.disabled}`);
        }

        function checkUsername() {
            const username = usernameInput.value.trim();
            if (!validateUsername()) {
                isUsernameValid = false;
                checkFormValidity();
                return;
            }

            fetch('/check_username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&mode=login`
            })
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Username check response:', data);
                usernameStatus.textContent = data.message;
                usernameStatus.style.display = 'block';
                if (data.available) {
                    usernameStatus.classList.remove('error-message');
                    usernameStatus.classList.add('success-message');
                    isUsernameValid = true;
                } else {
                    usernameStatus.classList.remove('success-message');
                    usernameStatus.classList.add('error-message');
                    isUsernameValid = false;
                }
                checkFormValidity();
            })
            .catch(error => {
                console.error('Error checking username:', error);
                usernameStatus.textContent = 'Error checking username.';
                usernameStatus.style.display = 'block';
                usernameStatus.classList.remove('success-message');
                usernameStatus.classList.add('error-message');
                isUsernameValid = false;
                checkFormValidity();
            });
        }

        // Event listeners
        usernameInput.addEventListener('input', checkUsername);
        passwordInput.addEventListener('input', validatePassword);

        // Touch event listeners for iOS
        submitBtn.addEventListener('touchstart', (event) => {
            console.log('Touchstart on submit button');
            if (!submitBtn.disabled) {
                submitBtn.classList.add('active');
            }
        });
        submitBtn.addEventListener('touchend', (event) => {
            console.log('Touchend on submit button');
            submitBtn.classList.remove('active');
            if (!submitBtn.disabled) {
                document.getElementById('login-form').submit();
                console.log('Form submitted via touchend');
            } else {
                console.log('Touchend ignored: Button is disabled');
            }
        });

        // Form submission handler
        document.getElementById('login-form').addEventListener('submit', (event) => {
            console.log('Form submit event triggered');
            if (submitBtn.disabled) {
                event.preventDefault();
                console.log('Form submission prevented: Button is disabled');
            } else {
                console.log('Form submission allowed: Valid inputs');
            }
        });

        // Initial validation
        validateUsername();
        validatePassword();
    </script>
{% endblock %}